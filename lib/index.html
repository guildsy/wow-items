<html>
<head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

	<style>
		body {
			background-color: #E4E4E4;
		}

		body, div {
			margin: 0;
			overflow: auto;
		}

		.list-col {
			width: 300px;
			height: 100%;
			border-right: 2px solid black;
			float: left;
		}

		.list-item {
			font-size: 20px;
			padding: 10px;
			cursor: pointer;
			border-bottom: 1px solid #D3D3D3;
		}

		.list-item:hover, .list-item.selected {
			background-color: #D3D3D3;
		}

		.item-col {
			padding: 10px;
		}

		.item-col.error {
			background-color: rgba(255, 0, 0, 0.5);
		}

		[name="boss"], [name="sourceID"] {
			display: inline-block !important;
			width: 150px !important;
		}

		select,
		input[type="text"] {
			display: block;
			margin: 10px 0;
			padding: 5px;
			width: 300px;
			border: 1px solid black;
			height: 25px;
		}

		.checkboxes {
			display: inline-block;
			vertical-align: top;
			margin: 5px 20px;
		}

		.checkboxes > label {
			display: block;
			padding: 5px 0;
		}

		[name$="DEATH_KNIGHT"] + span {
			color: #C41F3B;
		}

		[name$="DRUID"] + span {
			color: #FF7D0A;
		}

		[name$="HUNTER"] + span {
			color: #ABD473;
		}

		[name$="MAGE"] + span {
			color: #69CCF0;
		}

		[name$="MONK"] + span {
			color: #00FF96;
		}

		[name$="PALADIN"] + span {
			color: #F58CBA;
		}

		[name$="PRIEST"] + span {
			color: #000;
		}

		[name$="ROGUE"] + span {
			color: #FFF569;
		}

		[name$="SHAMAN"] + span {
			color: #0070DE;
		}

		[name$="WARLOCK"] + span {
			color: #9482C9;
		}

		[name$="WARRIOR"] + span {
			color: #C79C6E;
		}

		.button {
			display: inline-block;
			padding: 10px 15px;
			cursor: pointer;
			background-color: gray;
			text-transform: uppercase;
			color: #FFF;
		}

		.button.fluid {
			width: 100%;
			text-align: center;
			box-sizing: border-box;
		}

		.button.red {
			background-color: red;
		}

		.button.green {
			background-color: green;
		}

		.button.small {
			padding: 5px 5px;
		}

		.mtop20 {
			margin-top: 20px
		}

		#search {
			margin: 0;
			font-size: 20px;
			border: none;
			height: auto;
		}
	</style>
</head>
<body>
	<div class="list-col">
		<input id="search" type="text" placeholder="item name" />
		<div id="new" class="button fluid">new</div>
		<div id="check" class="green button fluid">check</div>
	</div>

	<div class="item-col">
		<label>Name: <input name="name" type="text" /></label>
		<label>id: <input name="id" type="text" /></label>
		<label>SourceID:<br/>
			<input name="sourceID" type="text" />
			<select name="boss">
				<option value="">Source</option>
			</select>
		</label>

		<select name="slot">
			<option value="">slot</option>
			<option value="MISC">Misc</option>
			<option value="HEAD">Head</option>
			<option value="NECK">Neck</option>
			<option value="SHOULDER">Shoulder</option>
			<option value="BACK">Back</option>
			<option value="CHEST">Chest</option>
			<option value="WRIST">Wrist</option>
			<option value="HANDS">Hands</option>
			<option value="WAIST">waist</option>
			<option value="LEGS">Legs</option>
			<option value="FEET">Feet</option>
			<option value="FINGER">Finger</option>
			<option value="TRINKET">Trinket</option>
			<option value="WEAPON">Weapon</option>
			<option value="OFFHAND">Offhand</option>
			<option value="WHATEVER_TOKEN">Whatever tier token</option>
		</select>

		<div class="buttons">
			<div id="intellect" class="small button">intellect</div>
			<div id="strength" class="small button">strength</div>
			<div id="agility" class="small button">agility</div>
			<br/>
			<div id="cloth" class="small button">cloth</div>
			<div id="leather" class="small button">leather</div>
			<div id="mail" class="small button">mail</div>
			<div id="plate" class="small button">plate</div>
			<br/>
			<div id="conq" class="small button">conq</div>
			<div id="vanq" class="small button">vanq</div>
			<div id="prot" class="small button">prot</div>
		</div>

		<div>
			<label class="checkboxes">MELEE:
				<label><input type="checkbox" name="MELEE-DEATH_KNIGHT" /><span>Death Knight</span></label>
				<label><input type="checkbox" name="MELEE-PALADIN" /><span>Paladin</span></label>
				<label><input type="checkbox" name="MELEE-WARRIOR" /><span>Warrior</span></label>
				<label><input type="checkbox" name="MELEE-SHAMAN" /><span>Shaman</span></label>
				<label><input type="checkbox" name="MELEE-DRUID" /><span>Druid</span></label>
				<label><input type="checkbox" name="MELEE-MONK" /><span>Monk</span></label>
				<label><input type="checkbox" name="MELEE-ROGUE" /><span>Rogue</span></label>
			</label>

			<label class="checkboxes">RANGED:
				<label><input type="checkbox" name="RANGED-HUNTER" /><span>Hunter</span></label>
				<label><input type="checkbox" name="RANGED-SHAMAN" /><span>Shaman</span></label>
				<label><input type="checkbox" name="RANGED-DRUID" /><span>Druid</span></label>
				<label><input type="checkbox" name="RANGED-PRIEST" /><span>Priest</span></label>
				<label><input type="checkbox" name="RANGED-MAGE" /><span>Mage</span></label>
				<label><input type="checkbox" name="RANGED-WARLOCK" /><span>Warlock</span></label>
			</label>

			<label class="checkboxes">HEALERS:
				<label><input type="checkbox" name="HEALERS-PALADIN" /><span>Paladin</span></label>
				<label><input type="checkbox" name="HEALERS-SHAMAN" /><span>Shaman</span></label>
				<label><input type="checkbox" name="HEALERS-DRUID" /><span>Druid</span></label>
				<label><input type="checkbox" name="HEALERS-MONK" /><span>Monk</span></label>
				<label><input type="checkbox" name="HEALERS-PRIEST" /><span>Priest</span></label>
			</label>

			<label class="checkboxes">TANKS:
				<label><input type="checkbox" name="TANKS-DEATH_KNIGHT" /><span>Death Knight</span></label>
				<label><input type="checkbox" name="TANKS-PALADIN" /><span>Paladin</span></label>
				<label><input type="checkbox" name="TANKS-WARRIOR" /><span>Warrior</span></label>
				<label><input type="checkbox" name="TANKS-DRUID" /><span>Druid</span></label>
				<label><input type="checkbox" name="TANKS-MONK" /><span>Monk</span></label>
			</label>
		</div>

		<div id="remove" class="button red mtop20">remove</div>
		<div id="send" class="button green mtop20">send</div>
	</div>

	<script>
		BOSSES = [
			['Hellfire Citadel Trash', '7545'],
			['Hellfire Assault', '95068'],
			['Iron Reaver', '90284'],
			['Kormrok', '90776'],
			['Kilrogg Deadeye', '90378'],
			['Hellfire High Council', '92146'],
			['Gorefiend', '91809'],
			['Shadow-Lord Iskar', '95067'],
			['Socrethar the Eternal', '90296'],
			['Tyrant Velhari', '93439'],
			['Fel Lord Zakuun', '89890'],
			['Xhul\'horac', '93068'],
			['Mannoroth', '91349'],
			['Archimonde', '91331']
		];

		ITEMS = {};
		CURRENT_ITEM = null;
		SEARCH = '';
		var $list;
		var $item;
		var EMPTY_ITEM = {
			allowed: {
				MELEE: [],
				RANGED: [],
				HEALERS: [],
				TANKS: []
			}
		};

		function getAll(cb) {
			$.getJSON('/items', function(data) {
				ITEMS = data;
				if (cb) cb();
			});
		}

		function renderList() {
			$list.find('.list-item').remove();

			var re = new RegExp(SEARCH, 'i');

			Object.keys(ITEMS).forEach(function(item, i) {
				item = ITEMS[item];

				if (SEARCH && ! item.name.match(re)) return;

				$('<div/>', {
					class: 'list-item',
					text: item.name,
					click: function() {
						$list.find('.list-item').removeClass('selected');
						$(this).addClass('selected');
						renderItem(item);
					}
				}).appendTo($list);
			});
		}

		function renderItem(item) {
			CURRENT_ITEM = item;
			$item.removeClass('error');

			$('[name="name"]').val(item.name);
			$('[name="id"]').val(item.id);
			$('[name="sourceID"]').val(item.sourceID);

			// reset incase of blanks
			$('[type="checkbox"]').prop('checked', false);

			$('[name="slot"]').val(item.slot);
			$('[name="boss"]').val(item.sourceID || '');

			Object.keys(item.allowed).forEach(function(role) {
				item.allowed[role].forEach(function(c) {
					$('[name="' + role + '-' + c + '"]').prop('checked', true);
				});
			});
		}

		function onSend() {
			var item = {
				allowed: {
					MELEE: [],
					RANGED: [],
					HEALERS: [],
					TANKS: []
				}
			};

			$('[type="checkbox"]').each(function() {
				var s = this.name.split('-');

				if (this.checked) {
					item.allowed[s[0]].push(s[1]);
				}
			});

			item.name = $('[name="name"]').val();
			item.id = $('[name="id"]').val();
			item.sourceID = $('[name="sourceID"]').val();
			item.slot = $('[name="slot"]').val();

			if (CURRENT_ITEM && CURRENT_ITEM.id && item.id !== CURRENT_ITEM.id) {
				item.oldItemID = CURRENT_ITEM.id;
			}

			var a = item.allowed;
			console.log(item);
			if ( ! item.name || ! item.id || ! item.sourceID
				 || ! item.slot ||
				 (! a.MELEE.length && ! a.RANGED.length
				 && ! a.HEALERS.length && ! a.TANKS.length)) {
				return $item.addClass('error');
			}

			$.ajax('/item', {
				type: 'POST',
				contentType: 'application/json; chatset=utf-8',
				dataType: 'json',
				data: JSON.stringify(item),
				success: function(data) {
					console.log('saved', item);
					getAll(renderList);

					// hack to stop having to set new boss
					EMPTY_ITEM.sourceID = item.sourceID;
					renderItem(EMPTY_ITEM);
				}
			});
		}

		function onRemove() {
			$.ajax('/item/' + CURRENT_ITEM.id, {
				type: 'DELETE',
				success: function() {
					delete ITEMS[CURRENT_ITEM.id];
					renderList();
					renderItem(EMPTY_ITEM);
				}
			});
		}

		function onNew() {
			renderItem(EMPTY_ITEM);
		}

		// go through and check that each items has
		// all the fields filled in
		function onCheck() {
			console.log('starting check');

			Object.keys(ITEMS).forEach(function(item) {
				item = ITEMS[item];
				var a = item.allowed;
				var errors = [];

				if ( ! item.name) errors.push('name');
				if ( ! item.sourceID) errors.push('sourceID');
				if ( ! item.slot) errors.push('slot');
				if ( ! a.MELEE.length && ! a.RANGED.length && ! a.HEALERS.length && ! a.TANKS.length) errors.push('allowed');

				if (errors.length) {
					console.warn('%s (%d) is missing: %s', item.name, item.id, errors.join(', '));
				}
			});

			console.log('check done');
		}

		$(function() {
			$list = $('.list-col');
			$item = $('.item-col');

			$('#send').click(onSend);
			$('#remove').click(onRemove);
			$('#new').click(onNew);
			$('#check').click(onCheck);

			$('#search').on('input', function(e) {
				SEARCH = this.value;
				renderList();
			});

			BOSSES.forEach(function(boss) {
				$('[name="boss"]').append($('<option>', {
					value: boss[1],
					text: boss[0]
				}));
			});

			$('[name="boss"]').change(function() {
				$('[name="sourceID"]').val($(this).val());
			});

			$('#intellect').click(function() {
				$('[name="RANGED-SHAMAN"]').prop('checked', true);
				$('[name="RANGED-DRUID"]').prop('checked', true);
				$('[name="RANGED-PRIEST"]').prop('checked', true);
				$('[name="RANGED-MAGE"]').prop('checked', true);
				$('[name="RANGED-WARLOCK"]').prop('checked', true);

				$('[name="HEALERS-PALADIN"]').prop('checked', true);
				$('[name="HEALERS-SHAMAN"]').prop('checked', true);
				$('[name="HEALERS-DRUID"]').prop('checked', true);
				$('[name="HEALERS-MONK"]').prop('checked', true);
				$('[name="HEALERS-PRIEST"]').prop('checked', true);

			});

			$('#strength').click(function() {
				$('[name="MELEE-DEATH_KNIGHT"]').prop('checked', true);
				$('[name="MELEE-PALADIN"]').prop('checked', true);
				$('[name="MELEE-WARRIOR"]').prop('checked', true);

				$('[name="TANKS-DEATH_KNIGHT"]').prop('checked', true);
				$('[name="TANKS-PALADIN"]').prop('checked', true);
				$('[name="TANKS-WARRIOR"]').prop('checked', true);
			});

			$('#agility').click(function() {
				$('[name="RANGED-HUNTER"]').prop('checked', true);

				$('[name="MELEE-SHAMAN"]').prop('checked', true);
				$('[name="MELEE-DRUID"]').prop('checked', true);
				$('[name="MELEE-MONK"]').prop('checked', true);
				$('[name="MELEE-HUNTER"]').prop('checked', true);

				$('[name="TANKS-DRUID"]').prop('checked', true);
				$('[name="TANKS-MONK"]').prop('checked', true);
			});

			$('#cloth').click(function() {
				$('[name="RANGED-PRIEST"]').prop('checked', true);
				$('[name="RANGED-MAGE"]').prop('checked', true);
				$('[name="RANGED-WARLOCK"]').prop('checked', true);

				$('[name="HEALERS-PRIEST"]').prop('checked', true);
			});

			$('#leather').click(function() {
				$('[name="MELEE-DRUID"]').prop('checked', true);
				$('[name="MELEE-MONK"]').prop('checked', true);
				$('[name="MELEE-ROGUE"]').prop('checked', true);

				$('[name="RANGED-DRUID"]').prop('checked', true);

				$('[name="HEALERS-DRUID"]').prop('checked', true);
				$('[name="HEALERS-MONK"]').prop('checked', true);

				$('[name="TANKS-DRUID"]').prop('checked', true);
				$('[name="TANKS-MONK"]').prop('checked', true);
			});

			$('#mail').click(function() {
				$('[name="MELEE-SHAMAN"]').prop('checked', true);

				$('[name="RANGED-HUNTER"]').prop('checked', true);
				$('[name="RANGED-SHAMAN"]').prop('checked', true);

				$('[name="HEALERS-SHAMAN"]').prop('checked', true);
			});

			$('#plate').click(function() {
				$('[name="MELEE-DEATH_KNIGHT"]').prop('checked', true);
				$('[name="MELEE-PALADIN"]').prop('checked', true);
				$('[name="MELEE-WARRIOR"]').prop('checked', true);

				$('[name="HEALERS-PALADIN"]').prop('checked', true);

				$('[name="TANKS-DEATH_KNIGHT"]').prop('checked', true);
				$('[name="TANKS-PALADIN"]').prop('checked', true);
				$('[name="TANKS-WARRIOR"]').prop('checked', true);
			});

			$('#conq').click(function() {
				$('[name="MELEE-PALADIN"]').prop('checked', true);

				$('[name="RANGED-PRIEST"]').prop('checked', true);
				$('[name="RANGED-WARLOCK"]').prop('checked', true);

				$('[name="HEALERS-PALADIN"]').prop('checked', true);
				$('[name="HEALERS-PRIEST"]').prop('checked', true);

				$('[name="TANKS-PALADIN"]').prop('checked', true);
			});

			$('#vanq').click(function() {
				$('[name="MELEE-DEATH_KNIGHT"]').prop('checked', true);
				$('[name="MELEE-DRUID"]').prop('checked', true);
				$('[name="MELEE-ROGUE"]').prop('checked', true);

				$('[name="RANGED-DRUID"]').prop('checked', true);
				$('[name="RANGED-MAGE"]').prop('checked', true);

				$('[name="HEALERS-DRUID"]').prop('checked', true);

				$('[name="TANKS-DEATH_KNIGHT"]').prop('checked', true);
				$('[name="TANKS-DRUID"]').prop('checked', true);
			});

			$('#prot').click(function() {
				$('[name="MELEE-WARRIOR"]').prop('checked', true);
				$('[name="MELEE-SHAMAN"]').prop('checked', true);
				$('[name="MELEE-MONK"]').prop('checked', true);

				$('[name="RANGED-HUNTER"]').prop('checked', true);
				$('[name="RANGED-SHAMAN"]').prop('checked', true);

				$('[name="HEALERS-SHAMAN"]').prop('checked', true);
				$('[name="HEALERS-MONK"]').prop('checked', true);

				$('[name="TANKS-WARRIOR"]').prop('checked', true);
				$('[name="TANKS-MONK"]').prop('checked', true);
			});

			getAll(renderList);
		});
	</script>
</body>
</html>
